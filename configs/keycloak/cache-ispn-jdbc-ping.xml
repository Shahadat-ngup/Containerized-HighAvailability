<?xml version="1.0" encoding="UTF-8"?>
<infinispan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="urn:infinispan:config:14.0 http://www.infinispan.org/schemas/infinispan-config-14.0.xsd"
            xmlns="urn:infinispan:config:14.0">

    <jgroups>
        <stack name="jdbc-ping-tcp">
            <TCP bind_port="7800" 
                 recv_buf_size="5M" 
                 send_buf_size="5M"
                 max_bundle_size="100K" 
                 sock_conn_timeout="300" 
                 thread_naming_pattern="cl"
                 bundler_type="transfer-queue" />

            <JDBC_PING connection_driver="org.postgresql.Driver"
                       connection_url="jdbc:postgresql://172.29.65.52:5432,172.29.65.53:5432,172.29.65.54:5432/keycloak"
                       connection_username="keycloak"
                       connection_password="${env.POSTGRES_PASSWORD}"
                       initialize_sql="CREATE TABLE IF NOT EXISTS JGROUPSPING (own_addr varchar(200) NOT NULL, cluster_name varchar(200) NOT NULL, ping_data bytea, constraint PK_JGROUPSPING PRIMARY KEY (own_addr, cluster_name))"
                       insert_single_sql="INSERT INTO JGROUPSPING (own_addr, cluster_name, ping_data) VALUES (?, ?, ?)"
                       delete_single_sql="DELETE FROM JGROUPSPING WHERE own_addr=? AND cluster_name=?"
                       select_all_pingdata_sql="SELECT ping_data FROM JGROUPSPING WHERE cluster_name=?"
                       info_writer_sleep_time="500" />

            <MERGE3 max_interval="30000" min_interval="10000" />
            <FD_SOCK />
            <VERIFY_SUSPECT timeout="1500" />
            <BARRIER />
            <pbcast.NAKACK2 use_mcast_xmit="false" 
                           discard_delivered_msgs="true" 
                           xmit_interval="1000"
                           xmit_table_num_rows="100"
                           xmit_table_msgs_per_row="2000"
                           xmit_table_max_compaction_time="30000" />
            <UNICAST3 xmit_interval="500"
                     xmit_table_num_rows="100"
                     xmit_table_msgs_per_row="1000"
                     xmit_table_max_compaction_time="60000" />
            <pbcast.STABLE stability_delay="1000" 
                          desired_avg_gossip="50000" 
                          max_bytes="4M" />
            <pbcast.GMS print_local_addr="true" 
                       join_timeout="5000" 
                       leave_timeout="5000"
                       view_bundling="true"
                       view_ack_collection_timeout="5000" />
            <UFC max_credits="2M" min_threshold="0.4" />
            <MFC max_credits="2M" min_threshold="0.4" />
            <FRAG2 frag_size="60K" />
        </stack>
    </jgroups>

    <cache-container name="keycloak">
        <transport lock-timeout="60000" 
                  stack="jdbc-ping-tcp" 
                  cluster="${infinispan.cluster.name:keycloak}"
                  node-name="${infinispan.node.name:}"
                  machine="${infinispan.machine.id:}"
                  rack="${infinispan.rack.id:}"
                  site="${infinispan.site.name:}" />
        
        <!-- Local caches for node-specific data -->
        <local-cache name="default">
            <expiration max-idle="10000" />
        </local-cache>
        
        <local-cache name="version">
            <expiration max-idle="300000" />
        </local-cache>
        
        <local-cache name="realms">
            <expiration max-idle="900000" />
            <memory max-count="10000" />
        </local-cache>
        
        <local-cache name="users">
            <expiration max-idle="600000" />
            <memory max-count="10000" />
        </local-cache>
        
        <!-- Distributed caches for session data -->
        <distributed-cache name="sessions" owners="2" segments="256">
            <expiration lifespan="-1" max-idle="1800000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="authenticationSessions" owners="2" segments="256">
            <expiration lifespan="1800000" max-idle="-1" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="offlineSessions" owners="2" segments="256">
            <expiration lifespan="-1" max-idle="2592000000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="clientSessions" owners="2" segments="256">
            <expiration lifespan="-1" max-idle="1800000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="offlineClientSessions" owners="2" segments="256">
            <expiration lifespan="-1" max-idle="2592000000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="loginFailures" owners="2" segments="256">
            <expiration lifespan="900000" max-idle="900000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <distributed-cache name="work" owners="2" segments="256">
            <expiration lifespan="900000" max-idle="900000" />
            <memory max-count="1000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
        
        <!-- Local cache for authorization -->
        <local-cache name="authorization">
            <expiration max-idle="900000" />
            <memory max-count="10000" />
        </local-cache>
        
        <!-- Replicated cache for keys -->
        <replicated-cache name="keys">
            <expiration lifespan="3600000" max-idle="3600000" />
            <memory max-count="1000" />
            <state-transfer timeout="60000" />
        </replicated-cache>
        
        <!-- Action tokens cache -->
        <distributed-cache name="actionTokens" owners="2" segments="256">
            <expiration max-idle="-1" lifespan="-1" interval="300000" />
            <memory max-count="10000" when-full="REMOVE" />
            <state-transfer timeout="60000" />
        </distributed-cache>
    </cache-container>
</infinispan>
