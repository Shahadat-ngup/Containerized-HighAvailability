scope: keycloak-postgres
namespace: /db/
name: patroni-1

restapi:
  listen: 172.29.65.52:8008
  connect_address: 172.29.65.52:8008

etcd:
  hosts: 172.29.65.52:2379,172.29.65.53:2379,172.29.65.54:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    master_start_timeout: 300
    synchronous_mode: true
    synchronous_mode_strict: false
    synchronous_node_count: 1
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        # Connection Settings
        max_connections: 200
        superuser_reserved_connections: 3
        
        # Memory Settings
        shared_buffers: 256MB
        effective_cache_size: 1GB
        work_mem: 4MB
        maintenance_work_mem: 64MB
        
        # Write Ahead Logging
        wal_level: replica
        max_wal_senders: 10
        max_replication_slots: 10
        wal_keep_size: 1GB
        wal_buffers: 16MB
        
        # Checkpoints
        checkpoint_completion_target: 0.9
        checkpoint_timeout: 5min
        
        # Replication
        wal_log_hints: on
        hot_standby: on
        hot_standby_feedback: on
        
        # Archiving
        archive_mode: on
        archive_command: '/bin/true'
        
        # Logging
        logging_collector: on
        log_destination: 'stderr'
        log_directory: '/var/log/postgresql'
        log_filename: 'postgresql-%Y-%m-%d_%H%M%S.log'
        log_truncate_on_rotation: on
        log_rotation_age: 1d
        log_rotation_size: 100MB
        log_min_duration_statement: 1000
        log_line_prefix: '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
        log_statement: 'ddl'
        log_lock_waits: on
        
        # Performance
        shared_preload_libraries: 'pg_stat_statements'
        track_activities: on
        track_counts: on
        track_io_timing: on
        track_functions: all
        
        # Autovacuum
        autovacuum: on
        autovacuum_max_workers: 3
        autovacuum_naptime: 1min
        
        # Connection Pooling Support
        listen_addresses: '*'
        port: 5432

  initdb:
  - encoding: UTF8
  - data-checksums
  - locale: C.UTF-8

  pg_hba:
  # Replication connections
  - host replication replicator 172.29.65.0/24 md5
  - host replication replicator 127.0.0.1/32 md5
  
  # Database connections
  - host all all 172.29.65.0/24 md5
  - host all all 127.0.0.1/32 md5
  - host all all ::1/128 md5
  
  # Local connections
  - local all all trust
  - local replication all trust

  users:
    admin:
      password: ${POSTGRES_ADMIN_PASSWORD}
      options:
        - createrole
        - createdb
        - login
    replicator:
      password: ${POSTGRES_REPLICATION_PASSWORD}
      options:
        - replication
        - login

postgresql:
  listen: 172.29.65.52:5432
  connect_address: 172.29.65.52:5432
  data_dir: /var/lib/postgresql/data
  bin_dir: /usr/lib/postgresql/17/bin
  pgpass: /tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: ${POSTGRES_REPLICATION_PASSWORD}
    superuser:
      username: postgres
      password: ${POSTGRES_ROOT_PASSWORD}
    rewind:
      username: replicator
      password: ${POSTGRES_REPLICATION_PASSWORD}
  parameters:
    unix_socket_directories: '/var/run/postgresql'
    shared_preload_libraries: 'pg_stat_statements'

tags:
    nofailover: false
    noloadbalance: false
    clonefrom: false
    nosync: false

watchdog:
  mode: off

# Callbacks for custom scripts
on_start: /opt/patroni/scripts/on_start.sh
on_stop: /opt/patroni/scripts/on_stop.sh
on_restart: /opt/patroni/scripts/on_restart.sh
on_reload: /opt/patroni/scripts/on_reload.sh
on_role_change: /opt/patroni/scripts/on_role_change.sh
